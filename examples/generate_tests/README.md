# Automatic test definition example
In [gentests_modelica_blocks_sources.py](/examples/generate_tests/gentests_modelica_blocks_sources.py) you find a
complete example on how automatic test generation works in MoPyRegtest. The script basically generates code
like you would create manually like in the example 
[test_Modelica_Electrical_Analog_Examples](/examples/test_Modelica_Electrical_Analog_Examples). 
Below you will find a detailed explanation of the generation example script. 

Tests can also be generated automatically from the command line using the `mopyregtest` command line tool.

Make sure to have MoPyRegtest installed via `pip`, see the [main README.md](/README.md).


## From the command line
First, we will generate the same test that is generated by the script in
[gentests_modelica_blocks_sources.py](/examples/generate_tests/gentests_modelica_blocks_sources.py),
but using the command line. 

On installation with `pip`, a command line tool called `mopyregtest` is created. As the [setup.py](/setup.py) states in the
`console_scripts` option, this command line tool is a wrapper around [`main` function of cli.py](/mopyregtest/cli.py). 
To see how it works, open a command line terminal and run

```bash
mopyregtest --help
```

which will print

```
usage: mopyregtest [-h] {generate,compare} ...

options:
  -h, --help          show this help message and exit

subcommands:
  {generate,compare}  mopyregtest CLI command overview
    generate          Generate test case definitions
    compare           Compare CSV result files

Command line interface for MoPyRegtest, the CI friendly regression testing tool for Modelica models. This command line interface is a simplified version to
interact with MoPyRegtest. If you want to use all options, please consider creating a dedicated Python script.
```

and furthermore

```bash
mopyregtest generate --help
```

tells you

```
usage: mopyregtest generate [-h] [--metric {norm_p_dist,norm_infty_dist,Lp_dist,Linfty_dist,abs_dist_ptwise}] [--tol TOL] [--references REFERENCES]
                            test_folder test_name package_folder models_in_package

positional arguments:
  test_folder           Path where test shall be generated. Advice: Should not exist yet
  test_name             Name of the test. Do not use special characters
  package_folder        Path to Modelica package from which models shall be tested. Relative paths are possible
  models_in_package     Comma separated list of model names like <model name1>,<model name2> to be turned into regression tests

options:
  -h, --help            show this help message and exit
  --metric {norm_p_dist,norm_infty_dist,Lp_dist,Linfty_dist,abs_dist_ptwise}
                        Metric to be used. Choose here from predefined values. For user-defined metrics please consider creating the tests with a dedicated
                        script. If omitted, the default is norm_infty_dist
  --tol TOL             Absolute tolerance up to which deviation in the comparison metric is accepted
  --references REFERENCES
                        Comma separated list like <model name1>:</path/to/ref1.csv>,<model name2>:</path/to/ref2.csv>. Missing references for models here will
                        be generated.
```

Just like in the
[gentests_modelica_blocks_sources.py](/examples/generate_tests/gentests_modelica_blocks_sources.py)
we generate regression tests for the models `Modelica.Blocks.Sources.Sine`, `Modelica.Blocks.Sources.ExpSine`, and
`Modelica.Blocks.Sources.Step` from the Modelica standard library. The test definition shall go in 
examples/generate_tests/gen_tests. The test shall be named `BlocksAbsDistPtwise_from_cli`. To achieve this, under Ubuntu Linux
change to the folder [examples/generate_tests](/examples/generate_tests), and simply run

```bash
cd examples/generate_tests
mopyregtest generate --metric=abs_dist_ptwise ./gen_tests BlocksAbsDistPtwise_from_cli ~/".openmodelica/libraries/Modelica 4.0.0+maint.om/" Modelica.Blocks.Sources.Sine,Modelica.Blocks.Sources.ExpSine,Modelica.Blocks.Sources.Step
```

and for Windows just adapt the path to the Modelica Standard library, e.g. to 
`"C:/Users/<your user name>/AppData/Roaming/.openmodelica/libraries/Modelica 4.0.0+maint.om"` (quotes might be required).

You will find the resulting test definition in gen_tests/test_blockslpdist_from_cli.py and the generated reference results in 
gen_tests/references. Note that you can also pass existing reference results to the `mopyregtest` command line tool 
through the `--references` option. E.g., if `Modelica.Blocks.Sources.Sine` had an existing reference result in 
`/home/<your user name>/Modelica.Blocks.Sources.Sine_res.csv`, then you would have to add the option

```bash
--references Modelica.Blocks.Sources.Sine:/home/<your user name>/Modelica.Blocks.Sources.Sine_res.csv
```

or as a comma separated list, if more models had pre-existing references. 

You can run the generated test just like the example explained above with `python3 test_blocksabsdistptwise_from_cli.py`. 

## Using a generator script
Just like with the example 
[test_modelica_electrical_analog_examples.py](/examples/test_Modelica_Electrical_Analog_Examples/test_modelica_electrical_analog_examples.py)
the script starts with paths where to find the Modelica package to be tested, here the path to the Modelica standard
library. 

Then, the folders that shall hold any results from running the generated tests as well as the target location for the
reference results are defined: 

```python
this_folder = pathlib.Path(__file__).absolute().parent
result_folder = this_folder

# Where to find reference results for this test
reference_folder = this_folder / "references"
```

Following that, the models in the package to be turned into regression tests are defined:
```python
# Generating a test battery with a predefined metric ###################################################################
# Models to generate regression tests for
models_in_package = ["Modelica.Blocks.Sources.Sine", "Modelica.Blocks.Sources.ExpSine", "Modelica.Blocks.Sources.Step"]
```

A `mopyregtest.Generator` object is instantiated
```python
gen = mopyregtest.Generator(package_folder=package_folder, models_in_package=models_in_package,
                            metric=mopyregtest.metrics.abs_dist_ptwise)
```

and the actual test generation is done with
```python
gen.generate_tests(test_folder=this_folder / "gen_tests", test_name="BlocksAbsDistPtwise",
                   test_results_folder=this_folder / "results")
```

Note that in the current implementation, all tests generated from a `mopyregtest.Generator` object use the same 
comparison metric.

If you wanted to use pre-existing reference results, e.g. if `Modelica.Blocks.Sources.Sine` had an existing reference 
result in `/home/<your user name>/Modelica.Blocks.Sources.Sine_res.csv`, you would have to create a dictionary like
```python
preexist_references = {"Modelica.Blocks.Sources.Sine": "/home/<your user name>/Modelica.Blocks.Sources.Sine_res.csv"}
```
and call
```python
gen.generate_tests(test_folder=this_folder / "gen_tests", test_name="BlocksLpDist",
                   test_results_folder=this_folder / "results",
                   references=preexist_references)
```

You can also pass user-defined metrics. However, for reasons of having to generate
them into code in the test definition file, you _must turn them into a string_. E.g.
```python
gen = mopyregtest.Generator(package_folder=package_folder, models_in_package=models_in_package,
                            metric="lambda r_ref, r_act: np.linalg.norm(r_ref[:, 1] - r_act[:, 1], ord=np.inf)")
```
